title: Setup basic authentication
description:
  - >
    We want to update the behavior of the proxy so that it checks for a valid username and password in the request
    headers before forwarding the request to the upstream. In the case of basic auth, the authorization header must
    match a username and password in the dictionary of users on the auth config.
steps:
  - apply:
      manifest:
        path: auth-config.yaml
    title: Create an auth config
    description:
      - >
        Now we can create an auth config in gloo to represent basic auth. Basic auth requires credentials in the APR format.
        We can generate a password with: `htpasswd -nbm user password`. This outputs something like `user:$apr1$TYiryv0/$8BvzLUO9IfGPGGsPnAgSu1`,
        which contains the salted username and password that we'll include in the auth config. Use `kubectl` to apply the following yaml:
    docsValues:
      RenderAsYaml: "true"
  - apply:
      manifest:
        path: vs-petstore-2.yaml
    title: Update the virtual service to add auth to the routes
    description:
      - Now we can update the virtual service. In this case, we'll add the auth config to all routes on the virtual service.
    docsValues:
      RenderAsYaml: "true"
  - curl:
      path: /sample-route-1
      statusCode: 401 # Unauthorized
      service:
        name: gateway-proxy
        namespace: gloo-system
    title: Test an unauthorized request
    description:
      - |
        If we curl the request as before:

        `curl $(glooctl proxy url)/sample-route-1`

        This should now return a 401 Unauthorized error, since the request doesn't contain the authorization header.
  - curl:
      path: /sample-route-1
      statusCode: 200 # Unauthorized
      service:
        name: gateway-proxy
        namespace: gloo-system
      headers:
        Authorization: "basic dXNlcjpwYXNzd29yZA=="
    title: Test an authorized request
    description:
      - |
        We can add the authorization header to the request to satisfy the auth check. First, encode the `user:password` with this command:

        `echo -n "user:password" | base64`

        Now we can issue a curl request with this value as the authorization header:

        `curl -H "Authorization: basic dXNlcjpwYXNzd29yZA==" $(glooctl proxy url)/sample-route-1`

        This should return a 200 and the following json:
        ```
        [{"id":1,"name":"Dog","status":"available"},{"id":2,"name":"Cat","status":"pending"}]